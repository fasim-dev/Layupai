<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>LayUp AI - Pakar Ayam Petelur</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
:root{
  --bg:#0b0f19; --panel:#121a2e; --panel2:#0e1425; --border:#2a3553;
  --accent:#f5c869; --muted:#a9b9da; --hover:#ffffff18;
  --shadow:0 12px 36px #0009;
  --success:#2bd47d; --warning:#ffc107; --danger:#ff667a; --info:#17a2b8;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:#fff;font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.app{display:flex;height:100vh;overflow:hidden}

/* ===== Sidebar + Backdrop ===== */
.sidebar-backdrop{position:fixed;inset:0;background:#0009;opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:24}
.sidebar-backdrop.show{opacity:1;pointer-events:auto;backdrop-filter:blur(2px)}
.sidebar{width:280px;background:var(--panel);border-right:1px solid var(--border);
  display:flex;flex-direction:column;transform:translateX(-100%);transition:transform .28s cubic-bezier(.22,.61,.36,1);
  z-index:25}
.sidebar.show{transform:translateX(0)}
.side-head{display:flex;align-items:center;gap:8px;padding:12px;border-bottom:1px solid var(--border);font-weight:700}
.side-list{flex:1;overflow:auto;padding:10px}
.group-title{font-size:12px;color:var(--muted);margin:10px 6px}
.item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;cursor:pointer;transition:background .2s}
.item:hover{background:#ffffff10}
.item .icon{width:22px;height:22px;border-radius:6px;background:#1a2641;display:flex;align-items:center;justify-content:center;font-size:12px}
.item .name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.side-foot{border-top:1px solid var(--border);padding:10px}
.account{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;cursor:pointer;transition:background .2s}
.account:hover{background:#ffffff10}
.account .avatar{width:28px;height:28px;border-radius:50%;background:#1a2641;display:flex;align-items:center;justify-content:center}

/* Specialized menu items */
.item.special{background:#1a2641;border:1px solid var(--border);margin:8px 0}
.item.special .icon{background:var(--accent);color:#000}

/* Account submenu */
.account-menu{position:fixed;left:14px;bottom:60px;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);display:none;min-width:200px;z-index:60;animation:pop .2s ease}
.account-menu.show{display:block}
.account-menu .row{padding:10px 12px;cursor:pointer}
.account-menu .row:hover{background:#ffffff12}

/* ===== Main ===== */
.main{flex:1;display:flex;flex-direction:column;min-width:0}

/* Header */
.topbar{display:flex;align-items:center;justify-content:space-between;background:var(--panel);
  border-bottom:1px solid var(--border);padding:10px 12px;position:sticky;top:0;z-index:30;backdrop-filter:saturate(1.1) blur(4px)}
.left{display:flex;align-items:center;gap:10px}
.toggler{border:1px solid var(--border);background:#ffffff10;color:#fff;border-radius:10px;padding:8px;cursor:pointer;transition:transform .15s, background .2s}
.toggler:hover{background:var(--hover)}
.toggler:active{transform:scale(.96)}
.brand{display:flex;align-items:center;gap:10px;font-weight:700}
.logo{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 210deg at 50% 50%, #80d0ff, #7df7cf, #e8ff9c, #80d0ff);box-shadow:0 0 0 2px #0002 inset}
.actions{display:flex;gap:8px}
.btn{border:1px solid var(--border);background:#ffffff10;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;transition:box-shadow .25s, background .2s, transform .12s}
.btn:hover{background:var(--hover);box-shadow:0 6px 18px #0006}
.btn:active{transform:translateY(1px)}
.icon-only .label{display:none}

/* Dropdown (⋮) */
.menu{position:absolute;right:12px;top:52px;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);min-width:220px;display:none;z-index:60;animation:pop .2s ease}
.menu.show{display:block}
.menu .item{display:flex;gap:10px;align-items:center;padding:10px 12px;cursor:pointer;color:#e6efff}
.menu .item:hover{background:#ffffff10}
.menu .item i{width:18px;text-align:center;color:#cfe2ff}

/* Stream */
.stream{flex:1;overflow:auto;padding:18px 14px;scroll-behavior:smooth}
.msg{display:grid;grid-template-columns:auto 1fr;gap:10px;margin:10px 0;animation:rise .25s ease both}
.avatar{width:34px;height:34px;border-radius:10px;background:#1b2540;display:flex;align-items:center;justify-content:center;font-size:18px}
.bubble{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px 12px;max-width:min(780px,90%);position:relative}
.user .bubble{background:#1a2641}
.content{word-break:break-word}
.meta{color:var(--muted);font-size:12px;margin-top:6px}

/* Specialized message types */
.bubble.info{background:#1a2641;border-color:var(--info)}
.bubble.success{background:#1a2e2a;border-color:var(--success)}
.bubble.warning{background:#2e281a;border-color:var(--warning)}
.bubble.danger{background:#2e1a1f;border-color:var(--danger)}

/* Cards for specialized content */
.card-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin:12px 0}
.card{padding:12px;background:var(--panel2);border-radius:12px;border:1px solid var(--border)}
.card h4{margin:0 0 8px 0;font-size:14px;color:var(--accent)}
.card p{margin:0;font-size:13px}

/* Calculator form */
.calc-form{display:grid;gap:10px;margin:12px 0}
.calc-form .field{display:grid;gap:4px}
.calc-form label{font-size:13px;color:var(--muted)}
.calc-form input, .calc-form select{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:8px;color:#fff}
.calc-form button{background:var(--accent);color:#000;border:none;padding:8px;border-radius:8px;font-weight:700;cursor:pointer}

/* Chart container */
.chart-container {
  position: relative;
  width: 100%;
  max-width: 100%;
  height: 240px; /* bisa disesuaikan, misalnya 200–300px */
  margin: 12px 0;
  overflow: hidden;
}

.chart-container canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;
}

/* Top tools (copy/edit on bubble) */
.tools{position:absolute;top:8px;right:8px;display:flex;gap:6px}
.tool-btn{background:#ffffff10;border:1px solid var(--border);color:#cfe2ff;padding:4px 6px;border-radius:8px;font-size:12px;cursor:pointer;transition:background .2s}
.tool-btn:hover{background:#ffffff18}

/* Bot action toolbar */
.bot-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.act{border:1px solid var(--border);background:#ffffff0f;color:#e6efff;border-radius:10px;padding:6px;display:inline-flex;gap:6px;align-items:center;cursor:pointer;font-size:12px;transition:background .2s, transform .12s}
.act:hover{background:#ffffff1a}
.act:active{transform:translateY(1px)}
.act.like.active{border-color:#2bd47d;background:#2bd47d22}
.act.dislike.active{border-color:#ff667a;background:#ff667a22}

/* Context menu (history & user bubble) */
.ctx{position:fixed;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);display:none;z-index:70;min-width:180px;animation:pop .18s ease}
.ctx.show{display:block}
.ctx .row{padding:10px 12px;cursor:pointer;display:flex;gap:8px;align-items:center}
.ctx .row:hover{background:#ffffff12}

/* Composer */
.dock{border-top:1px solid var(--border);padding:14px;background:linear-gradient(180deg,#0b0f19 0%, #0b0f19e0 70%, #0b0f19)}
.compose-wrap{display:flex;justify-content:center}
.compose{position:relative;display:flex;align-items:center;gap:8px;background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:10px;max-width:780px;width:100%;box-shadow:0 6px 24px #0006}
.icon-left,.icon-right{display:flex;gap:6px;align-items:center}
.icon-btn{border:1px solid var(--border);background:#ffffff10;color:#e6efff;border-radius:10px;padding:8px;cursor:pointer;transition:background .2s, transform .12s}
.icon-btn:hover{background:#ffffff18}
.icon-btn:active{transform:translateY(1px)}
.textbox{flex:1;min-height:24px;max-height:160px}
.textbox textarea{width:100%;min-height:24px;max-height:160px;resize:none;border:0;outline:none;background:transparent;color:#fff;font:15px/1.5 inherit;padding:4px 6px}
.send{background:var(--accent);border:none;color:#000;font-weight:700;padding:10px 12px;border-radius:12px;cursor:pointer;transition:transform .12s, box-shadow .2s}
.send:hover{box-shadow:0 8px 18px #0007}
.send:active{transform:translateY(1px)}
.send:disabled{opacity:.5;cursor:not-allowed}

/* Attach submenu */
.attach-menu{position:absolute;left:46px;bottom:60px;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);display:none;z-index:65;min-width:160px;animation:pop .18s ease}
.attach-menu.show{display:block}
.attach-menu .row{padding:10px 12px;display:flex;gap:8px;align-items:center;cursor:pointer}
.attach-menu .row:hover{background:#ffffff12}

/* Fullscreen Composer */
.overlay{position:fixed;inset:0;background:#0008;display:none;z-index:70;align-items:center;justify-content:center;animation:fade .2s ease}
.overlay.show{display:flex}
.overlay .panel{width:min(980px,92vw);height:min(70vh,560px);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow);animation:pop .22s ease}
.overlay textarea{flex:1;background:var(--panel2);color:#fff;border:1px solid var(--border);border-radius:12px;resize:none;padding:12px}
.overlay .row{display:flex;gap:8px;justify-content:flex-end}
.ghost{background:#ffffff10;border:1px solid var(--border);color:#e6efff;padding:10px 12px;border-radius:10px;cursor:pointer}
.ghost:hover{background:#ffffff18}

/* Typing */
.typing{display:flex;gap:5px;align-items:center}
.dot{width:7px;height:7px;background:#fff;border-radius:50%;opacity:.4;animation:blink 1.3s infinite}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.25}40%{opacity:1}}

/* Toast */
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#10182c;border:1px solid var(--border);color:#dbe7ff;padding:10px 14px;border-radius:10px;z-index:80;box-shadow:0 10px 30px #0008;opacity:0;pointer-events:none;transition:opacity .2s}
.toast.show{opacity:1}

/* Dark modal (rename, confirm, qna) */
.modal-backdrop{position:fixed;inset:0;background:#0008;display:none;z-index:75;align-items:center;justify-content:center;backdrop-filter:blur(3px);animation:fade .2s ease}
.modal-backdrop.show{display:flex}
.modal{width:min(520px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:14px;animation:pop .18s ease}
.modal h3{margin:0 0 8px 0}
.modal .desc{color:var(--muted);font-size:13px;margin-bottom:10px}
.modal .field{margin:8px 0}
.modal input, .modal textarea{width:100%;background:var(--panel2);color:#fff;border:1px solid var(--border);border-radius:10px;padding:10px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.modal .danger{background:#ff6b81;border:none;color:white}
.modal .primary{background:var(--accent);border:none;color:#000}
.modal .ghost{background:#ffffff10;border:1px solid var(--border);color:#e6efff}

/* Animations */
@keyframes pop{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
@keyframes fade{from{opacity:0}to{opacity:1}}
@keyframes rise{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* Responsive */
@media (max-width:860px){
  .sidebar{position:fixed;height:100%;top:0;left:0;width:50vw}
}
@media (max-width:520px){
  .sidebar{width:50vw}
}
@media (max-width:640px){
  .bubble{max-width:100%}
}
  /* === Perbaikan Responsif === */

/* Sidebar: biar teks panjang bisa wrap */
.sidebar .name {
  white-space: normal;
  word-break: break-word;
}

/* Header: biar tombol wrap kalau layar kecil */
.topbar {
  flex-wrap: wrap;
  gap: 6px;
}

/* Bubble: pastikan konten panjang (misalnya URL) tetap wrap */
.bubble .content {
  overflow-wrap: break-word;
  word-break: break-word;
}

/* Card grid: kurangi min-width supaya bisa masuk di layar sempit */
.card-grid {
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
}
.card {
  min-width: 0; /* biar flex/grid tidak maksa lebar */
}

/* Chart container: pastikan tidak overflow */
.chart-container, 
.chart-container canvas {
  width: 100% !important;
  max-width: 100%;
}

/* Modal input/select: pastikan tidak melebar */
.modal input, 
.modal select, 
.modal textarea {
  max-width: 100%;
  box-sizing: border-box;
}

/* Composer: biar tombol dan textarea lebih fleksibel di layar kecil */
/* Composer tetap 1 baris */
.compose {
  flex-wrap: nowrap;   /* jangan pecah baris */
}
.compose .textbox {
  flex: 1 1 auto;      /* textarea tetap fleksibel, tapi sejajar */
  min-width: 0;        /* biar nggak maksa overflow */
}
  /* Form di modal dark mode */
.modal input,
.modal select,
.modal textarea {
  background: var(--panel2) !important;
  color: #fff !important;
  border: 1px solid var(--border) !important;
  border-radius: 10px;
  padding: 8px;
  appearance: none; /* hilangkan default bawaan browser */
}

/* Dropdown arrow untuk select */
.modal select {
  background-image: linear-gradient(45deg, transparent 50%, #ccc 50%),
                    linear-gradient(135deg, #ccc 50%, transparent 50%);
  background-position: right 12px top 50%, right 8px top 50%;
  background-size: 6px 6px, 6px 6px;
  background-repeat: no-repeat;
  padding-right: 28px;
}

/* Option dalam select */
.modal select option {
  background: var(--panel2);
  color: #fff;
}
  /* Custom Select */
.custom-select {
  position: relative;
  background: var(--panel2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 12px;
  color: #fff;
  cursor: pointer;
  user-select: none;
}

.custom-select .selected {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.custom-select .selected::after {
  content: "▼";
  font-size: 12px;
  margin-left: 8px;
  color: var(--muted);
}

/* Dropdown global (ditempel ke body) */
.custom-options {
  position: absolute;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  max-height: 160px;
  overflow-y: auto;
  box-shadow: var(--shadow);
  z-index: 100000;
  display: none;
}

.custom-options li {
  padding: 8px 12px;
  cursor: pointer;
  color: #fff;
}

.custom-options li:hover {
  background: var(--hover);
}
  /* default: opsi ke bawah */
.custom-select {
  position: relative;
  background: var(--panel2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 12px;
  color: #fff;
  cursor: pointer;
  user-select: none;
  overflow: visible !important; /* <– biar dropdown bisa keluar */
}
  
  /* Kotak multi-select */
.custom-multiselect {
  position: relative;
  background: var(--panel2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 6px 10px;
  color: #fff;
  cursor: pointer;
  user-select: none;
  min-height: 40px;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 4px;
}

/* Tag hasil pilihan */
.custom-multiselect .tag {
  background: var(--panel);
  border-radius: 6px;
  padding: 2px 6px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.custom-multiselect .tag span {
  cursor: pointer;
  font-weight: bold;
}

</style>
</head>
<body>
<div class="app">
  <!-- Sidebar Backdrop -->
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="side-head">LayUp AI - Pakar Layer</div>
    <div class="side-list">
      <div class="group-title">Fitur Khusus</div>
      <div class="item special" id="healthDiagnosis">
        <div class="icon"><i class="fa-solid fa-stethoscope"></i></div>
        <div class="name">Diagnosis Kesehatan</div>
      </div>
      <div class="item special" id="feedCalculator">
        <div class="icon"><i class="fa-solid fa-calculator"></i></div>
        <div class="name">Kalkulator Pakan</div>
      </div>
      <div class="item special" id="productionTracker">
        <div class="icon"><i class="fa-solid fa-chart-line"></i></div>
        <div class="name">Pelacak Produksi</div>
      </div>
      <div class="item special" id="diseaseEncyclopedia">
        <div class="icon"><i class="fa-solid fa-book-medical"></i></div>
        <div class="name">Ensiklopedia Penyakit</div>
      </div>
      
      <div class="group-title">Riwayat Chat</div>
      <div id="historyActive"></div>
      <div class="group-title" style="margin-top:14px">Arsip</div>
      <div id="historyArchive"></div>
    </div>
    <div class="side-foot">
      <div class="account" id="accountBtn">
        <div class="avatar">🧑</div>
        <div style="flex:1">
          <div style="font-weight:600">Akun Peternak</div>
          <div style="color:var(--muted);font-size:12px">free plan</div>
        </div>
        <i class="fa-solid fa-chevron-up"></i>
      </div>
    </div>
  </aside>

  <!-- ACCOUNT MENU -->
  <div class="account-menu" id="accountMenu">
    <div class="row" id="accProfile"><i class="fa-regular fa-user"></i> Profil</div>
    <div class="row" id="accSettings"><i class="fa-solid fa-gear"></i> Pengaturan</div>
    <div class="row" id="accLogout"><i class="fa-solid fa-right-from-bracket"></i> Keluar</div>
  </div>

  <!-- MAIN -->
  <main class="main" id="mainArea">
    <!-- Header -->
    <header class="topbar">
      <div class="left">
        <button class="toggler" id="sideToggle" title="Buka/tutup sidebar"><i class="fa-solid fa-bars"></i></button>
        <div class="brand"><div class="logo" aria-hidden="true"></div><div class="title">LayUp AI</div></div>
      </div>
      <div class="actions">
        <button class="btn icon-only" id="newChatBtn" title="Chat baru"><i class="fa-solid fa-plus"></i><span class="label">New Chat</span></button>
        <button class="btn icon-only" id="moreBtn" title="Menu"><i class="fa-solid fa-ellipsis-vertical"></i><span class="label">More</span></button>
        <!-- Dropdown ⋮ -->
        <div class="menu" id="moreMenu" role="menu" aria-hidden="true">
          <div class="item" id="addQna"><i class="fa-solid fa-square-plus"></i><span>Tambah QnA</span></div>
          <div class="item" id="exportChat"><i class="fa-solid fa-file-export"></i><span>Export Chat</span></div>
          <div class="item" id="importChat"><i class="fa-solid fa-file-import"></i><span>Import Chat</span></div>
        </div>
      </div>
    </header>

    <!-- Chat stream -->
    <section class="stream" id="stream" aria-live="polite"></section>

    <!-- Composer -->
    <footer class="dock">
      <div class="compose-wrap">
        <div class="compose">
          <!-- Left icons -->
          <div class="icon-left">
            <button class="icon-btn" id="micBtn" title="Suara (mic)"><i class="fa-solid fa-microphone"></i></button>
            <button class="icon-btn" id="attachBtn" title="Lampiran"><i class="fa-solid fa-plus"></i></button>
          </div>
          <div class="textbox"><textarea id="input" placeholder="yuk tanya tentang ayam petelur…"></textarea></div>
          <div class="icon-right">
            <button class="icon-btn" id="expandBtn" title="Perbesar"><i class="fa-solid fa-up-right-and-down-left-from-center"></i></button>
            <button class="send" id="sendBtn" title="Kirim"><i class="fa-solid fa-paper-plane"></i></button>
          </div>

          <!-- Attach submenu -->
          <div class="attach-menu" id="attachMenu">
            <div class="row" id="attachCamera"><i class="fa-solid fa-camera"></i> Kamera</div>
            <div class="row" id="attachPhoto"><i class="fa-solid fa-image"></i> Foto</div>
            <div class="row" id="attachFile"><i class="fa-solid fa-file-arrow-up"></i> File</div>
          </div>
        </div>
      </div>
    </footer>
  </main>
</div>

<!-- File inputs -->
<input type="file" id="fileInput" style="display:none"/>
<input type="file" id="camInput" accept="image/*" capture="environment" style="display:none"/>
<input type="file" id="photoInput" accept="image/*" style="display:none"/>
<input type="file" id="importFile" accept="application/json" style="display:none"/>

<!-- Fullscreen Composer -->
<div class="overlay" id="overlay">
  <div class="panel">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700">Compose</div>
      <button class="ghost" id="closeOverlay"><i class="fa-solid fa-compress"></i> Tutup</button>
    </div>
    <textarea id="overlayInput" placeholder="Tulis pertanyaan di sini…"></textarea>
    <div class="row">
      <button class="ghost" id="overlayCancel">Batal</button>
      <button class="send" id="overlaySend">Kirim</button>
    </div>
  </div>
</div>

<!-- Context menu: History item -->
<div class="ctx" id="ctxHistory">
  <div class="row" data-act="rename"><i class="fa-regular fa-pen-to-square"></i> Ganti nama</div>
  <div class="row" data-act="archive"><i class="fa-regular fa-folder"></i> Arsipkan</div>
  <div class="row" data-act="delete"><i class="fa-regular fa-trash-can"></i> Hapus</div>
</div>

<!-- Context menu: User bubble -->
<div class="ctx" id="ctxUser">
  <div class="row" data-act="copy"><i class="fa-regular fa-copy"></i> Salin teks</div>
  <div class="row" data-act="select"><i class="fa-regular fa-square"></i> Pilih teks</div>
  <div class="row" data-act="edit"><i class="fa-regular fa-pen-to-square"></i> Edit pesan</div>
</div>

<!-- Dark Modal: Rename -->
<div class="modal-backdrop" id="modalRename">
  <div class="modal">
    <h3>Ganti Nama Chat</h3>
    <div class="desc">Masukkan nama baru untuk riwayat chat ini.</div>
    <div class="field"><input id="renameInput" placeholder="Nama baru"/></div>
    <div class="actions">
      <button class="ghost" data-close="#modalRename">Batal</button>
      <button class="primary" id="renameSave">Simpan</button>
    </div>
  </div>
</div>

<!-- Dark Modal: Confirm Delete -->
<div class="modal-backdrop" id="modalConfirm">
  <div class="modal">
    <h3>Hapus Chat?</h3>
    <div class="desc">Tindakan ini tidak bisa dibatalkan, Bosku.</div>
    <div class="actions">
      <button class="ghost" data-close="#modalConfirm">Batal</button>
      <button class="danger" id="confirmDelete">Hapus</button>
    </div>
  </div>
</div>

<!-- Dark Modal: Tambah QnA -->
<div class="modal-backdrop" id="modalQna">
  <div class="modal">
    <h3>Tambah QnA</h3>
    <div class="desc">Data disimpan lokal (browser) dan langsung dipakai AI.</div>
    <div class="field">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Pertanyaan</div>
      <input id="qnaQ" placeholder="Contoh: Apa itu pakan layer?"/>
    </div>
    <div class="field">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Jawaban</div>
      <textarea id="qnaA" rows="3" placeholder="Jawaban ringkas dan jelas…"></textarea>
    </div>
    <div class="actions">
      <button class="ghost" data-close="#modalQna">Batal</button>
      <button class="primary" id="qnaSave">Simpan</button>
    </div>
  </div>
</div>

<!-- Modal: Health Diagnosis -->
<div class="modal-backdrop" id="modalHealth">
  <div class="modal">
    <h3><i class="fa-solid fa-stethoscope"></i> Diagnosis Kesehatan Ayam</h3>
    <div class="desc">Pilih gejala yang dialami ayam untuk mendapatkan diagnosis.</div>
    
    <div class="field">
  <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Gejala yang Diamati</div>
  
  <!-- Custom Multi Select -->
  <div class="custom-multiselect" data-target="symptoms">
    <div class="selected">Pilih gejala</div>
  </div>

  <!-- hidden select tetap ada, tapi disembunyikan -->
  <select id="symptoms" multiple style="display:none">
    <option value="nafsu_makan_turun">Nafsu makan turun</option>
    <option value="lesu">Lesu dan tidak aktif</option>
    <option value="bulu_kusam">Bulu kusam dan berdiri</option>
    <option value="diare">Diare (mencret)</option>
    <option value="gangguan_pernafasan">Gangguan pernafasan</option>
    <option value="produksi_telur_turun">Produksi telur menurun</option>
    <option value="telur_abnormal">Telur abnormal (kerabang tipis, bentuk tidak normal)</option>
    <option value="warna_comb_pucat">Warna comb pucat</option>
    <option value="pembengkakan">Pembengkakan pada wajah atau persendian</option>
    <option value="kelumpuhan">Kelumpuhan atau gangguan syaraf</option>
  </select>
</div>
    
    <div class="actions">
      <button class="ghost" data-close="#modalHealth">Batal</button>
      <button class="primary" id="healthDiagnose">Diagnosis</button>
    </div>
  </div>
</div>

<!-- Modal: Feed Calculator -->
<div class="modal-backdrop" id="modalFeed">
  <div class="modal">
    <h3><i class="fa-solid fa-calculator"></i> Kalkulator Pakan</h3>
    <div class="desc">Hitung kebutuhan pakan berdasarkan jumlah dan umur ayam.</div>
    
    <div class="field">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Jumlah Ayam</div>
      <input type="number" id="feedChickenCount" placeholder="Contoh: 100" min="1"/>
    </div>
    
    <div class="field">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Umur Ayam (minggu)</div>
      <input type="number" id="feedChickenAge" placeholder="Contoh: 20" min="1" max="100"/>
    </div>
    
    <div class="field">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Jenis Ayam</div>
      <select id="feedChickenType">
        <option value="layer">Layer (Petelur)</option>
        <option value="broiler">Broiler (Pedaging)</option>
      </select>
    </div>
    
    <div class="actions">
      <button class="ghost" data-close="#modalFeed">Batal</button>
      <button class="primary" id="feedCalculate">Hitung</button>
    </div>
  </div>
</div>

<!-- Modal: Production Tracker -->
<div class="modal-backdrop" id="modalProduction">
  <div class="modal">
    <h3><i class="fa-solid fa-chart-line"></i> Pelacak Produksi Telur</h3>
    <div class="desc">Masukkan data produksi harian untuk melihat tren.</div>
    
    <div class="field">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Tanggal</div>
      <input type="date" id="prodDate"/>
    </div>
    
    <div class="field">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Jumlah Telur</div>
      <input type="number" id="prodEggCount" placeholder="Contoh: 85" min="0"/>
    </div>
    
    <div class="field">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Jumlah Ayam</div>
      <input type="number" id="prodChickenCount" placeholder="Contoh: 100" min="1"/>
    </div>
    
    <div class="actions">
      <button class="ghost" data-close="#modalProduction">Batal</button>
      <button class="primary" id="prodSave">Simpan Data</button>
    </div>
  </div>
</div>

<!-- Modal: Disease Encyclopedia -->
<div class="modal-backdrop" id="modalDisease">
  <div class="modal">
    <h3><i class="fa-solid fa-book-medical"></i> Ensiklopedia Penyakit</h3>
    <div class="desc">Pilih penyakit untuk melihat informasi lengkap.</div>
    
    <div class="field">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Penyakit</div>
      <select id="diseaseSelect">
        <option value="">-- Pilih penyakit --</option>
        <option value="newcastle">Newcastle Disease (ND)</option>
        <option value="gumboro">Gumboro (IBD)</option>
        <option value="bronchitis">Bronchitis Infeksius (IB)</option>
        <option value="coccidiosis">Coccidiosis</option>
        <option value="marek">Marek's Disease</option>
        <option value="avian_influenza">Avian Influenza (AI)</option>
        <option value="fowl_pox">Fowl Pox</option>
        <option value="crdf">Chronic Respiratory Disease (CRD)</option>
      </select>
    </div>
    
    <div class="actions">
      <button class="ghost" data-close="#modalDisease">Batal</button>
      <button class="primary" id="diseaseInfo">Lihat Informasi</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ===== KONFIGURASI & INISIALISASI =====
const APP_NAME = 'LayUp AI';
const JSON_URL = 'https://fasim-dev.github.io/Layupai/knowledge.json';
let knowledgeBase = []; // Basis pengetahuan dari JSON
let customQna = [];     // QnA tambahan dari user
let fuse;               // Fuse.js instance untuk pencarian
let currentChatId = null;
let currentCtx = null;
let currentCtxData = null;
let activeChats = [];
let archivedChats = [];
let productionData = [];

// Inisialisasi aplikasi
function initApp() {
  loadData();
  setupEventListeners();
  createNewChat();
  fetchKnowledgeBase();
}

// ===== FETCH KNOWLEDGE BASE =====
async function fetchKnowledgeBase() {
  try {
    console.log('Memulai fetch dari:', JSON_URL);
    
    // Tambahkan timestamp untuk menghindari cache
    const url = JSON_URL + '?t=' + new Date().getTime();
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      mode: 'cors'
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Data berhasil diambil:', data);
    
    // Periksa struktur data
    if (data && Array.isArray(data.faq)) {
      knowledgeBase = data.faq;
      console.log(`Loaded ${knowledgeBase.length} items from knowledge base`);
      showToast('Basis pengetahuan berhasil dimuat');
    } else if (Array.isArray(data)) {
      knowledgeBase = data;
      console.log(`Loaded ${knowledgeBase.length} items from knowledge base`);
      showToast('Basis pengetahuan berhasil dimuat');
    } else {
      console.warn('Struktur JSON tidak sesuai:', data);
      showToast('Struktur JSON tidak sesuai', 'warning');
    }
    
    // Inisialisasi Fuse.js setelah data dimuat
    initFuse();
    
  } catch (error) {
    console.error('Error fetching knowledge base:', error);
    showToast('Gagal memuat basis pengetahuan', 'error');
    
    // Coba fallback ke file lokal jika tersedia
    try {
      // Ini hanya contoh, Anda bisa menambahkan fallback ke file lokal
      // knowledgeBase = [...]; 
      console.log('Menggunakan data fallback');
    } catch (fallbackError) {
      console.error('Juga gagal menggunakan fallback:', fallbackError);
    }
  }
}

// Inisialisasi Fuse.js untuk pencarian
function initFuse() {
  const options = {
    includeScore: true,
    keys: ['question', 'answer', 'keywords']
  };
  
  // Gabungkan knowledge base dengan custom QnA
  const searchData = [...knowledgeBase, ...customQna];
  fuse = new Fuse(searchData, options);
  console.log('Fuse.js initialized with', searchData.length, 'items');
}

// ===== MANAJEMEN DATA LOKAL =====
function loadData() {
  const savedChats = localStorage.getItem('layup_chats');
  const savedCustom = localStorage.getItem('layup_custom_qna');
  const savedProduction = localStorage.getItem('layup_production');

  if (savedChats) {
    const chats = JSON.parse(savedChats);
    activeChats = chats.active || [];
    archivedChats = chats.archived || [];
    renderHistory();
  }

  if (savedCustom) {
    customQna = JSON.parse(savedCustom);
  }

  if (savedProduction) {
    productionData = JSON.parse(savedProduction);
  }
}

function saveData() {
  const chatData = {
    active: activeChats,
    archived: archivedChats
  };
  localStorage.setItem('layup_chats', JSON.stringify(chatData));
  localStorage.setItem('layup_custom_qna', JSON.stringify(customQna));
  localStorage.setItem('layup_production', JSON.stringify(productionData));
}

// ===== MANAJEMEN CHAT =====
function createNewChat() {
  const newId = 'chat_' + Date.now();
  currentChatId = newId;
  
  const newChat = {
    id: newId,
    title: 'Chat Baru',
    messages: [],
    createdAt: new Date().toISOString()
  };
  
  activeChats.unshift(newChat);
  saveData();
  renderHistory();
  clearStream();
  
  // Tambahkan pesan sambutan
  addBotMessage('Halo! Saya LayUp AI, asisten pakar ayam petelur. Silakan tanyakan apa saja tentang beternak ayam petelur, penyakit, pakan, atau manajemen kandang.');
}

function clearStream() {
  document.getElementById('stream').innerHTML = '';
}

function renderChat() {
  const chat = getCurrentChat();
  if (!chat) return;
  
  clearStream();
  chat.messages.forEach(msg => {
    if (msg.role === 'user') {
      addUserMessage(msg.content, false);
    } else {
      addBotMessage(msg.content, false);
    }
  });
}

function getCurrentChat() {
  return activeChats.find(chat => chat.id === currentChatId);
}

// ===== RENDER HISTORY =====
function renderHistory() {
  const activeContainer = document.getElementById('historyActive');
  const archiveContainer = document.getElementById('historyArchive');
  
  activeContainer.innerHTML = '';
  archivedChats.forEach(chat => {
    const el = createHistoryElement(chat, true);
    archiveContainer.appendChild(el);
  });
  
  activeChats.forEach(chat => {
    const el = createHistoryElement(chat, false);
    activeContainer.appendChild(el);
  });
}

function createHistoryElement(chat, isArchived) {
  const div = document.createElement('div');
  div.className = 'item' + (chat.id === currentChatId ? ' active' : '');
  div.innerHTML = `
    <div class="icon"><i class="fa-regular fa-message"></i></div>
    <div class="name">${chat.title}</div>
  `;
  
  div.addEventListener('click', () => {
    if (chat.id !== currentChatId) {
      currentChatId = chat.id;
      renderChat();
      renderHistory();
    }
  });
  
  // Context menu untuk history item
  div.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    currentCtx = 'history';
    currentCtxData = chat;
    showContextMenu(e, 'ctxHistory');
  });
  
  return div;
}

// ===== PESAN =====
function addUserMessage(content, save = true) {
  const stream = document.getElementById('stream');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'msg user';
  msgDiv.innerHTML = `
    <div class="avatar">🧑</div>
    <div class="bubble">
      <div class="content">${content}</div>
      <div class="tools">
        <button class="tool-btn" title="Salin"><i class="fa-regular fa-copy"></i></button>
        <button class="tool-btn" title="Edit"><i class="fa-regular fa-pen-to-square"></i></button>
      </div>
    </div>
  `;
  
  stream.appendChild(msgDiv);
  stream.scrollTop = stream.scrollHeight;
  
  if (save) {
    const chat = getCurrentChat();
    if (chat) {
      chat.messages.push({
        role: 'user',
        content: content,
        timestamp: new Date().toISOString()
      });
      
      // Update judul chat berdasarkan pesan pertama
      if (chat.messages.length === 1) {
        chat.title = content.length > 30 ? content.substring(0, 30) + '...' : content;
        renderHistory();
      }
      
      saveData();
    }
  }
  
  return msgDiv;
}

function addBotMessage(content, save = true, type = 'normal') {
  const stream = document.getElementById('stream');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'msg bot';
  
  let bubbleClass = 'bubble';
  if (type === 'info') bubbleClass += ' info';
  else if (type === 'success') bubbleClass += ' success';
  else if (type === 'warning') bubbleClass += ' warning';
  else if (type === 'error') bubbleClass += ' danger';
  
  msgDiv.innerHTML = `
    <div class="avatar"><i class="fa-solid fa-robot"></i></div>
    <div class="${bubbleClass}">
      <div class="content">${content}</div>
      <div class="meta">${APP_NAME} · ${new Date().toLocaleTimeString()}</div>
      <div class="bot-actions">
        <button class="act like" title="Suka"><i class="fa-regular fa-thumbs-up"></i></button>
        <button class="act dislike" title="Tidak Suka"><i class="fa-regular fa-thumbs-down"></i></button>
        <button class="act" title="Salin"><i class="fa-regular fa-copy"></i></button>
      </div>
    </div>
  `;
  
  stream.appendChild(msgDiv);
  stream.scrollTop = stream.scrollHeight;
  
  if (save) {
    const chat = getCurrentChat();
    if (chat) {
      chat.messages.push({
        role: 'assistant',
        content: content,
        timestamp: new Date().toISOString()
      });
      saveData();
    }
  }
  
  return msgDiv;
}

// ===== PENCARIAN JAWABAN =====
function findAnswer(question) {
  if (!fuse) {
    console.warn('Fuse.js belum diinisialisasi');
    return null;
  }
  
  const results = fuse.search(question);
  if (results.length > 0 && results[0].score < 0.3) {
    return results[0].item.answer;
  }
  
  return null;
}

// ===== PROSES PERTANYAAN USER =====
function processQuestion(question) {
  addUserMessage(question);
  
  // Tampilkan indikator typing
  const typingIndicator = showTyping();
  
  // Delay untuk simulasi AI "berpikir"
  setTimeout(() => {
    // Hapus indikator typing
    if (typingIndicator) {
      typingIndicator.remove();
    }
    
    // Cari jawaban
    const answer = findAnswer(question);
    
    if (answer) {
      addBotMessage(answer);
    } else {
      // Jika tidak ditemukan jawaban
      addBotMessage(
        `Maaf, saya belum memiliki informasi spesifik tentang "${question}". ` +
        `Sebagai alternatif, Anda bisa:\n\n` +
        `• Menggunakan fitur "Diagnosis Kesehatan" untuk masalah kesehatan ayam\n` +
        `• Menggunakan "Kalkulator Pakan" untuk menghitung kebutuhan pakan\n` +
        `• Membuka "Ensiklopedia Penyakit" untuk informasi penyakit unggas\n\n` +
        `Atau coba tanyakan dengan formulasi pertanyaan yang berbeda.`,
        true,
        'info'
      );
    }
  }, 1000 + Math.random() * 1000);
}

function showTyping() {
  const stream = document.getElementById('stream');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'msg bot';
  msgDiv.innerHTML = `
    <div class="avatar"><i class="fa-solid fa-robot"></i></div>
    <div class="bubble">
      <div class="typing">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </div>
  `;
  
  stream.appendChild(msgDiv);
  stream.scrollTop = stream.scrollHeight;
  return msgDiv;
}

// ===== UI FUNCTIONS =====
function showToast(message, type = 'normal') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  
  toast.className = 'toast';
  if (type === 'error') toast.classList.add('error');
  else if (type === 'success') toast.classList.add('success');
  else if (type === 'warning') toast.classList.add('warning');
  
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

function showContextMenu(e, menuId) {
  const menu = document.getElementById(menuId);
  menu.style.left = e.pageX + 'px';
  menu.style.top = e.pageY + 'px';
  menu.classList.add('show');
  
  const hideMenu = () => {
    menu.classList.remove('show');
    document.removeEventListener('click', hideMenu);
  };
  
  setTimeout(() => {
    document.addEventListener('click', hideMenu);
  }, 10);
}

function showModal(selector) {
  document.querySelector(selector).classList.add('show');
}

function hideModal(selector) {
  document.querySelector(selector).classList.remove('show');
}

// ===== SETUP EVENT LISTENERS =====
function setupEventListeners() {
  // Toggle sidebar
  document.getElementById('sideToggle').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('show');
    document.getElementById('sidebarBackdrop').classList.toggle('show');
  });
  
  document.getElementById('sidebarBackdrop').addEventListener('click', () => {
    document.getElementById('sidebar').classList.remove('show');
    document.getElementById('sidebarBackdrop').classList.remove('show');
  });
  
  // Input text message
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (input.value.trim()) {
        processQuestion(input.value.trim());
        input.value = '';
      }
    }
  });
  
  sendBtn.addEventListener('click', () => {
    if (input.value.trim()) {
      processQuestion(input.value.trim());
      input.value = '';
    }
  });
  
  // More menu (⋮)
  document.getElementById('moreBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('moreMenu').classList.toggle('show');
  });
  
  document.addEventListener('click', () => {
    document.getElementById('moreMenu').classList.remove('show');
  });
  
  // New chat
  document.getElementById('newChatBtn').addEventListener('click', createNewChat);
  
  // Account menu
  document.getElementById('accountBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('accountMenu').classList.toggle('show');
  });
  
  // Attach menu
  document.getElementById('attachBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('attachMenu').classList.toggle('show');
  });
  
  // Expand composer
  document.getElementById('expandBtn').addEventListener('click', () => {
    document.getElementById('overlay').classList.add('show');
    document.getElementById('overlayInput').value = input.value;
    document.getElementById('overlayInput').focus();
  });
  
  // Close overlay
  document.getElementById('closeOverlay').addEventListener('click', () => {
    document.getElementById('overlay').classList.remove('show');
  });
  
  document.getElementById('overlayCancel').addEventListener('click', () => {
    document.getElementById('overlay').classList.remove('show');
  });
  
  document.getElementById('overlaySend').addEventListener('click', () => {
    const overlayInput = document.getElementById('overlayInput');
    if (overlayInput.value.trim()) {
      processQuestion(overlayInput.value.trim());
      overlayInput.value = '';
      document.getElementById('overlay').classList.remove('show');
    }
  });
  
  // Fitur khusus
  document.getElementById('healthDiagnosis').addEventListener('click', () => {
    showModal('#modalHealth');
  });
  
  document.getElementById('feedCalculator').addEventListener('click', () => {
    showModal('#modalFeed');
  });
  
  document.getElementById('productionTracker').addEventListener('click', () => {
    showModal('#modalProduction');
  });
  
  document.getElementById('diseaseEncyclopedia').addEventListener('click', () => {
    showModal('#modalDisease');
  });
  
  // Tombol diagnosis
  document.getElementById('healthDiagnose').addEventListener('click', () => {
    const symptoms = Array.from(document.getElementById('symptoms').selectedOptions)
      .map(option => option.value);
    
    if (symptoms.length === 0) {
      showToast('Pilih setidaknya satu gejala', 'warning');
      return;
    }
    
    hideModal('#modalHealth');
    
    // Simulasi diagnosis
    addUserMessage('Diagnosis kesehatan dengan gejala: ' + symptoms.join(', '));
    const typing = showTyping();
    
    setTimeout(() => {
      typing.remove();
      addBotMessage(
        `Berdasarkan gejala yang dipilih, kemungkinan ayam mengalami **Newcastle Disease (ND)**.\n\n` +
        `**Rekomendasi:**\n` +
        `• Isolasi ayam yang sakit\n` +
        `• Tingkatkan biosecurity kandang\n` +
        `• Berikan vitamin dan elektrolit\n` +
        `• Konsultasi dengan dokter hewan untuk penanganan lebih lanjut\n\n` +
        `*Disclaimer: Diagnosis ini berdasarkan gejala yang dipilih dan mungkin tidak akurat 100%.*`,
        true,
        'warning'
      );
    }, 2000);
  });
  
  // Tombol kalkulator pakan
  document.getElementById('feedCalculate').addEventListener('click', () => {
    const count = parseInt(document.getElementById('feedChickenCount').value);
    const age = parseInt(document.getElementById('feedChickenAge').value);
    const type = document.getElementById('feedChickenType').value;
    
    if (!count || !age) {
      showToast('Masukkan jumlah dan umur ayam', 'warning');
      return;
    }
    
    hideModal('#modalFeed');
    
    // Hitung kebutuhan pakan
    let feedPerChicken;
    if (type === 'layer') {
      if (age < 5) feedPerChicken = 0.05;
      else if (age < 10) feedPerChicken = 0.07;
      else if (age < 20) feedPerChicken = 0.1;
      else feedPerChicken = 0.12;
    } else {
      // broiler
      if (age < 3) feedPerChicken = 0.05;
      else if (age < 6) feedPerChicken = 0.1;
      else feedPerChicken = 0.15;
    }
    
    const totalFeed = count * feedPerChicken;
    
    addUserMessage(`Hitung kebutuhan pakan untuk ${count} ekor ayam ${type} umur ${age} minggu`);
    
    addBotMessage(
      `**Hasil Perhitungan:**\n` +
      `• Jumlah ayam: ${count} ekor\n` +
      `• Umur: ${age} minggu\n` +
      `• Jenis: ${type === 'layer' ? 'Petelur (Layer)' : 'Pedaging (Broiler)'}\n` +
      `• Kebutuhan per ekor: ${feedPerChicken} kg/hari\n` +
      `• **Total kebutuhan pakan: ${totalFeed.toFixed(2)} kg/hari**\n\n` +
      `*Catatan: Perhitungan ini adalah estimasi. Sesuaikan dengan kondisi aktual ayam.*`,
      true,
      'success'
    );
  });
  
  // Initialize the app
  initApp();
}

// Start the application when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
